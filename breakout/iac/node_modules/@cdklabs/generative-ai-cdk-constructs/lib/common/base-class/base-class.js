"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BaseClass = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
const aws_cdk_lib_1 = require("aws-cdk-lib");
const appsync = require("aws-cdk-lib/aws-appsync");
const lambda = require("aws-cdk-lib/aws-lambda");
const logs = require("aws-cdk-lib/aws-logs");
const constructs_1 = require("constructs");
const construct_name_enum_1 = require("./construct-name-enum");
const utils_1 = require("../helpers/utils");
class BaseClass extends constructs_1.Construct {
    constructor(scope, id) {
        super(scope, id);
        /**
         * construct usage metric , added in template description
         */
        this.constructUsageMetric = 'uksb-1tupboc45';
        /**
         * enable disable lambda tracing
         *
         * @default - Active
         */
        this.lambdaTracing = lambda.Tracing.ACTIVE;
        /**
         * enable disable xray tracing
         *
         * @default - True
         */
        this.enablexray = true;
        /**
         * Default  log config for all constructs
         */
        this.fieldLogLevel = appsync.FieldLogLevel.ALL;
        /**
         * Default  log retention config for all constructs
         */
        this.retention = logs.RetentionDays.TEN_YEARS;
    }
    //overwrite default env suffix
    updateEnvSuffix(props) {
        let stage = '-dev';
        if (props?.stage) {
            stage = props.stage;
        }
        this.stage = stage;
    }
    /*
    * If enableOperationalMetric is set to true,
    * update template description with construct usage metric and
    * add AWS_SDK_UA_APP_ID to user agent on aws sdk.
    */
    updateConstructUsageMetricCode(props, scope, lambdaFunctions) {
        const solutionId = `genai_cdk_${utils_1.version}/${props.constructName}/${props.constructId}`;
        const enableOperationalMetric = props.enableOperationalMetric !== undefined &&
            props.enableOperationalMetric !== null ? props.enableOperationalMetric : true;
        if (enableOperationalMetric) {
            if (lambdaFunctions
                && lambdaFunctions.length > 0) {
                for (let lambdaFunction of lambdaFunctions) {
                    lambdaFunction.addEnvironment('AWS_SDK_UA_APP_ID', solutionId);
                }
            }
            if (props && BaseClass.usageMetricMap.hasOwnProperty(props.constructName)) {
                BaseClass.usageMetricMap[props.constructName] = BaseClass.usageMetricMap[props.constructName] + 1;
            }
            else {
                throw Error('construct name is not present in usageMetricMap ');
            }
            const usageMetricMapSerialized = JSON.stringify(BaseClass.usageMetricMap).replace(/[{}]/g, '').replace(/"/g, '');
            // Description format :(usage id :uksb-1tupboc45)(version:0.0.0) (constructs :::{\"C1\":1,\"C2\":5,\"C3\":3,\"C4\":0,\"C5\":0,\"C6\":0,\"C7\":0,\"C8\":0}) ",
            // where C1,C2, etc are mapped with construct-name-enum and the values shows the number of time stack created/deleted.
            aws_cdk_lib_1.Stack.of(scope).templateOptions.description =
                `Description: (${this.constructUsageMetric}) (version:${utils_1.version}) (tag:${usageMetricMapSerialized}) `;
        }
        ;
    }
    // observability
    addObservabilityToConstruct(props) {
        if (props.observability == false) {
            this.enablexray = false;
            this.lambdaTracing = lambda.Tracing.DISABLED;
            this.fieldLogLevel = appsync.FieldLogLevel.NONE;
            this.retention = logs.RetentionDays.TEN_YEARS;
        }
        ;
    }
}
exports.BaseClass = BaseClass;
_a = JSII_RTTI_SYMBOL_1;
BaseClass[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.BaseClass", version: "0.1.122" };
/**
 * Record<string, number> , maps construct name with number of deployments
 */
BaseClass.usageMetricMap = {
    [construct_name_enum_1.ConstructName.AWSRAGAPPSYNCSTEPFNOPENSEARCH]: 0,
    [construct_name_enum_1.ConstructName.AWSQAAPPSYNCOPENSEARCH]: 0,
    [construct_name_enum_1.ConstructName.AWSSUMMARIZATIONAPPSYNCSTEPFN]: 0,
    [construct_name_enum_1.ConstructName.AWSMODELDEPLOYMENTSAGEMAKER]: 0,
    [construct_name_enum_1.ConstructName.CUSTOMSAGEMAKERENDPOINT]: 0,
    [construct_name_enum_1.ConstructName.HUGGINGFACESAGEMAKERENDPOINT]: 0,
    [construct_name_enum_1.ConstructName.JUMPSTARTSAGEMAKERENDPOINT]: 0,
    [construct_name_enum_1.ConstructName.AWSCONTENTGENAPPSYNCLAMBDA]: 0,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1jbGFzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tb24vYmFzZS1jbGFzcy9iYXNlLWNsYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7QUFDSCw2Q0FBb0M7QUFDcEMsbURBQW1EO0FBQ25ELGlEQUFpRDtBQUNqRCw2Q0FBNkM7QUFDN0MsMkNBQXVDO0FBQ3ZDLCtEQUFzRDtBQUN0RCw0Q0FBMkM7QUE2QzNDLE1BQWEsU0FBVSxTQUFRLHNCQUFTO0lBc0R0QyxZQUFZLEtBQWdCLEVBQUUsRUFBVTtRQUN0QyxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBdENuQjs7V0FFRztRQUNNLHlCQUFvQixHQUFHLGdCQUFnQixDQUFDO1FBU2pEOzs7O1dBSUc7UUFDSCxrQkFBYSxHQUFpQixNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUVwRDs7OztXQUlHO1FBQ0gsZUFBVSxHQUFZLElBQUksQ0FBQztRQUUzQjs7V0FFRztRQUNILGtCQUFhLEdBQXVCLE9BQU8sQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDO1FBRTlEOztXQUVHO1FBQ0gsY0FBUyxHQUFxQixJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQztJQU0zRCxDQUFDO0lBRUQsOEJBQThCO0lBQ3BCLGVBQWUsQ0FBQyxLQUFxQjtRQUM3QyxJQUFJLEtBQUssR0FBRyxNQUFNLENBQUM7UUFDbkIsSUFBSSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUM7WUFDakIsS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUM7UUFDdEIsQ0FBQztRQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ3JCLENBQUM7SUFFRDs7OztNQUlFO0lBQ1EsOEJBQThCLENBQUMsS0FBcUIsRUFBRSxLQUFnQixFQUFFLGVBQTZDO1FBRTdILE1BQU0sVUFBVSxHQUFHLGFBQWEsZUFBTyxJQUFJLEtBQUssQ0FBQyxhQUFhLElBQUksS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRXRGLE1BQU0sdUJBQXVCLEdBQzNCLEtBQUssQ0FBQyx1QkFBdUIsS0FBSyxTQUFTO1lBQzNDLEtBQUssQ0FBQyx1QkFBdUIsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBRWhGLElBQUksdUJBQXVCLEVBQUUsQ0FBQztZQUM1QixJQUFJLGVBQWU7bUJBQ1osZUFBZSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDbEMsS0FBSyxJQUFJLGNBQWMsSUFBSSxlQUFlLEVBQUUsQ0FBQztvQkFDM0MsY0FBYyxDQUFDLGNBQWMsQ0FDM0IsbUJBQW1CLEVBQUUsVUFBVSxDQUNoQyxDQUFDO2dCQUNKLENBQUM7WUFDSCxDQUFDO1lBRUQsSUFBSSxLQUFLLElBQUksU0FBUyxDQUFDLGNBQWMsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7Z0JBQzFFLFNBQVMsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxHQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxHQUFDLENBQUMsQ0FBQztZQUNoRyxDQUFDO2lCQUFNLENBQUM7Z0JBQ04sTUFBTSxLQUFLLENBQUMsa0RBQWtELENBQUMsQ0FBQztZQUNsRSxDQUFDO1lBRUQsTUFBTSx3QkFBd0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFFakgsNkpBQTZKO1lBQzdKLHNIQUFzSDtZQUN0SCxtQkFBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxlQUFlLENBQUMsV0FBVztnQkFDM0MsaUJBQWlCLElBQUksQ0FBQyxvQkFBb0IsY0FBYyxlQUFPLFVBQVcsd0JBQXdCLElBQUksQ0FBQztRQUV6RyxDQUFDO1FBQUEsQ0FBQztJQUNKLENBQUM7SUFFRCxnQkFBZ0I7SUFDTiwyQkFBMkIsQ0FBQyxLQUFxQjtRQUN6RCxJQUFJLEtBQUssQ0FBQyxhQUFhLElBQUksS0FBSyxFQUFFLENBQUM7WUFDakMsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7WUFDeEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQztZQUM3QyxJQUFJLENBQUMsYUFBYSxHQUFFLE9BQU8sQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDO1lBQy9DLElBQUksQ0FBQyxTQUFTLEdBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUM7UUFDL0MsQ0FBQztRQUFBLENBQUM7SUFDSixDQUFDOztBQW5ISCw4QkFvSEM7OztBQWxIQzs7R0FFRztBQUNjLHdCQUFjLEdBQTJCO0lBQ3hELENBQUMsbUNBQWEsQ0FBQyw2QkFBNkIsQ0FBQyxFQUFFLENBQUM7SUFDaEQsQ0FBQyxtQ0FBYSxDQUFDLHNCQUFzQixDQUFDLEVBQUUsQ0FBQztJQUN6QyxDQUFDLG1DQUFhLENBQUMsNkJBQTZCLENBQUMsRUFBRSxDQUFDO0lBQ2hELENBQUMsbUNBQWEsQ0FBQywyQkFBMkIsQ0FBQyxFQUFFLENBQUM7SUFDOUMsQ0FBQyxtQ0FBYSxDQUFDLHVCQUF1QixDQUFDLEVBQUUsQ0FBQztJQUMxQyxDQUFDLG1DQUFhLENBQUMsNEJBQTRCLENBQUMsRUFBRSxDQUFDO0lBQy9DLENBQUMsbUNBQWEsQ0FBQywwQkFBMEIsQ0FBQyxFQUFFLENBQUM7SUFDN0MsQ0FBQyxtQ0FBYSxDQUFDLDBCQUEwQixDQUFDLEVBQUUsQ0FBQztDQUM5QyxBQVQ4QixDQVM3QiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiAgd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBvciBpbiB0aGUgJ2xpY2Vuc2UnIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICdBUyBJUycgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFU1xuICogIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zXG4gKiAgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5pbXBvcnQgeyBTdGFjayB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIGFwcHN5bmMgZnJvbSAnYXdzLWNkay1saWIvYXdzLWFwcHN5bmMnO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0ICogYXMgbG9ncyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbG9ncyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IENvbnN0cnVjdE5hbWUgfSBmcm9tICcuL2NvbnN0cnVjdC1uYW1lLWVudW0nO1xuaW1wb3J0IHsgdmVyc2lvbiB9IGZyb20gJy4uL2hlbHBlcnMvdXRpbHMnO1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgQmFzZUNsYXNzUHJvcHMge1xuICAvKipcbiAgICogVmFsdWUgd2lsbCBiZSBhcHBlbmRlZCB0byByZXNvdXJjZXMgbmFtZS5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBfZGV2XG4gICAqL1xuICByZWFkb25seSBzdGFnZT86IHN0cmluZztcblxuXG4gIC8qKlxuICAgKiBPcHRpb25hbC5DREsgY29uc3RydWN0cyBwcm92aWRlZCBjb2xsZWN0cyBhbm9ueW1vdXMgb3BlcmF0aW9uYWxcbiAgICogbWV0cmljcyB0byBoZWxwIEFXUyBpbXByb3ZlIHRoZSBxdWFsaXR5IGFuZCBmZWF0dXJlcyBvZiB0aGVcbiAgICogY29uc3RydWN0cy4gRGF0YSBjb2xsZWN0aW9uIGlzIHN1YmplY3QgdG8gdGhlIEFXUyBQcml2YWN5IFBvbGljeVxuICAgKiAoaHR0cHM6Ly9hd3MuYW1hem9uLmNvbS9wcml2YWN5LykuIFRvIG9wdCBvdXQgb2YgdGhpcyBmZWF0dXJlLFxuICAgKiBzaW1wbHkgZGlzYWJsZSBpdCBieSBzZXR0aW5nIHRoZSBjb25zdHJ1Y3QgcHJvcGVydHlcbiAgICogXCJlbmFibGVPcGVyYXRpb25hbE1ldHJpY1wiIHRvIGZhbHNlIGZvciBlYWNoIGNvbnN0cnVjdCB1c2VkLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIHRydWVcbiAgICovXG4gIHJlYWRvbmx5IGVuYWJsZU9wZXJhdGlvbmFsTWV0cmljPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogbmFtZSBvZiB0aGUgY29uc3RydWN0LlxuICAgKlxuICAgKi9cbiAgcmVhZG9ubHkgY29uc3RydWN0TmFtZTogQ29uc3RydWN0TmFtZTtcblxuICAvKipcbiAgICogY29uc3RydWN0IGlkLlxuICAgKlxuICAgKi9cbiAgcmVhZG9ubHkgY29uc3RydWN0SWQ6IHN0cmluZztcblxuICAvKipcbiAgICogRW5hYmxlIG9ic2VydmFiaWxpdHkuIFdhcm5pbmc6IGFzc29jaWF0ZWQgY29zdCB3aXRoIHRoZSBzZXJ2aWNlc1xuICAgKiB1c2VkLiBCZXN0IHByYWN0aWNlIHRvIGVuYWJsZSBieSBkZWZhdWx0LlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIHRydWVcbiAgICovXG4gIHJlYWRvbmx5IG9ic2VydmFiaWxpdHk/OiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgQmFzZUNsYXNzIGV4dGVuZHMgQ29uc3RydWN0IHtcblxuICAvKipcbiAgICogUmVjb3JkPHN0cmluZywgbnVtYmVyPiAsIG1hcHMgY29uc3RydWN0IG5hbWUgd2l0aCBudW1iZXIgb2YgZGVwbG95bWVudHNcbiAgICovXG4gIHByb3RlY3RlZCBzdGF0aWMgdXNhZ2VNZXRyaWNNYXAgOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+ID17XG4gICAgW0NvbnN0cnVjdE5hbWUuQVdTUkFHQVBQU1lOQ1NURVBGTk9QRU5TRUFSQ0hdOiAwLFxuICAgIFtDb25zdHJ1Y3ROYW1lLkFXU1FBQVBQU1lOQ09QRU5TRUFSQ0hdOiAwLFxuICAgIFtDb25zdHJ1Y3ROYW1lLkFXU1NVTU1BUklaQVRJT05BUFBTWU5DU1RFUEZOXTogMCxcbiAgICBbQ29uc3RydWN0TmFtZS5BV1NNT0RFTERFUExPWU1FTlRTQUdFTUFLRVJdOiAwLFxuICAgIFtDb25zdHJ1Y3ROYW1lLkNVU1RPTVNBR0VNQUtFUkVORFBPSU5UXTogMCxcbiAgICBbQ29uc3RydWN0TmFtZS5IVUdHSU5HRkFDRVNBR0VNQUtFUkVORFBPSU5UXTogMCxcbiAgICBbQ29uc3RydWN0TmFtZS5KVU1QU1RBUlRTQUdFTUFLRVJFTkRQT0lOVF06IDAsXG4gICAgW0NvbnN0cnVjdE5hbWUuQVdTQ09OVEVOVEdFTkFQUFNZTkNMQU1CREFdOiAwLFxuICB9O1xuXG5cbiAgLyoqXG4gICAqIGNvbnN0cnVjdCB1c2FnZSBtZXRyaWMgLCBhZGRlZCBpbiB0ZW1wbGF0ZSBkZXNjcmlwdGlvblxuICAgKi9cbiAgcmVhZG9ubHkgY29uc3RydWN0VXNhZ2VNZXRyaWMgPSAndWtzYi0xdHVwYm9jNDUnO1xuXG4gIC8qKlxuICAgKiBWYWx1ZSB3aWxsIGJlIGFwcGVuZGVkIHRvIHJlc291cmNlcyBuYW1lLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIF9kZXZcbiAgICovXG4gIHN0YWdlITogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBlbmFibGUgZGlzYWJsZSBsYW1iZGEgdHJhY2luZ1xuICAgKlxuICAgKiBAZGVmYXVsdCAtIEFjdGl2ZVxuICAgKi9cbiAgbGFtYmRhVHJhY2luZzogbGFtYmRhLlRyYWNpbmc9bGFtYmRhLlRyYWNpbmcuQUNUSVZFO1xuXG4gIC8qKlxuICAgKiBlbmFibGUgZGlzYWJsZSB4cmF5IHRyYWNpbmdcbiAgICpcbiAgICogQGRlZmF1bHQgLSBUcnVlXG4gICAqL1xuICBlbmFibGV4cmF5OiBib29sZWFuID0gdHJ1ZTtcblxuICAvKipcbiAgICogRGVmYXVsdCAgbG9nIGNvbmZpZyBmb3IgYWxsIGNvbnN0cnVjdHNcbiAgICovXG4gIGZpZWxkTG9nTGV2ZWw6YXBwc3luYy5GaWVsZExvZ0xldmVsPWFwcHN5bmMuRmllbGRMb2dMZXZlbC5BTEw7XG5cbiAgLyoqXG4gICAqIERlZmF1bHQgIGxvZyByZXRlbnRpb24gY29uZmlnIGZvciBhbGwgY29uc3RydWN0c1xuICAgKi9cbiAgcmV0ZW50aW9uOiBsb2dzLlJldGVudGlvbkRheXM9bG9ncy5SZXRlbnRpb25EYXlzLlRFTl9ZRUFSUztcblxuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gIH1cblxuICAvL292ZXJ3cml0ZSBkZWZhdWx0IGVudiBzdWZmaXhcbiAgcHJvdGVjdGVkIHVwZGF0ZUVudlN1ZmZpeChwcm9wczogQmFzZUNsYXNzUHJvcHMpIHtcbiAgICBsZXQgc3RhZ2UgPSAnLWRldic7XG4gICAgaWYgKHByb3BzPy5zdGFnZSkge1xuICAgICAgc3RhZ2UgPSBwcm9wcy5zdGFnZTtcbiAgICB9XG4gICAgdGhpcy5zdGFnZSA9IHN0YWdlO1xuICB9XG5cbiAgLypcbiAgKiBJZiBlbmFibGVPcGVyYXRpb25hbE1ldHJpYyBpcyBzZXQgdG8gdHJ1ZSxcbiAgKiB1cGRhdGUgdGVtcGxhdGUgZGVzY3JpcHRpb24gd2l0aCBjb25zdHJ1Y3QgdXNhZ2UgbWV0cmljIGFuZFxuICAqIGFkZCBBV1NfU0RLX1VBX0FQUF9JRCB0byB1c2VyIGFnZW50IG9uIGF3cyBzZGsuXG4gICovXG4gIHByb3RlY3RlZCB1cGRhdGVDb25zdHJ1Y3RVc2FnZU1ldHJpY0NvZGUocHJvcHM6IEJhc2VDbGFzc1Byb3BzLCBzY29wZTogQ29uc3RydWN0LCBsYW1iZGFGdW5jdGlvbnM6IGxhbWJkYS5Eb2NrZXJJbWFnZUZ1bmN0aW9uW10sXG4gICkge1xuICAgIGNvbnN0IHNvbHV0aW9uSWQgPSBgZ2VuYWlfY2RrXyR7dmVyc2lvbn0vJHtwcm9wcy5jb25zdHJ1Y3ROYW1lfS8ke3Byb3BzLmNvbnN0cnVjdElkfWA7XG5cbiAgICBjb25zdCBlbmFibGVPcGVyYXRpb25hbE1ldHJpYyA9XG4gICAgICBwcm9wcy5lbmFibGVPcGVyYXRpb25hbE1ldHJpYyAhPT0gdW5kZWZpbmVkICYmXG4gICAgICBwcm9wcy5lbmFibGVPcGVyYXRpb25hbE1ldHJpYyAhPT0gbnVsbCA/IHByb3BzLmVuYWJsZU9wZXJhdGlvbmFsTWV0cmljIDogdHJ1ZTtcblxuICAgIGlmIChlbmFibGVPcGVyYXRpb25hbE1ldHJpYykge1xuICAgICAgaWYgKGxhbWJkYUZ1bmN0aW9uc1xuICAgICAgICAgICYmIGxhbWJkYUZ1bmN0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGZvciAobGV0IGxhbWJkYUZ1bmN0aW9uIG9mIGxhbWJkYUZ1bmN0aW9ucykge1xuICAgICAgICAgIGxhbWJkYUZ1bmN0aW9uLmFkZEVudmlyb25tZW50KFxuICAgICAgICAgICAgJ0FXU19TREtfVUFfQVBQX0lEJywgc29sdXRpb25JZCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChwcm9wcyAmJiBCYXNlQ2xhc3MudXNhZ2VNZXRyaWNNYXAuaGFzT3duUHJvcGVydHkocHJvcHMuY29uc3RydWN0TmFtZSkpIHtcbiAgICAgICAgQmFzZUNsYXNzLnVzYWdlTWV0cmljTWFwW3Byb3BzLmNvbnN0cnVjdE5hbWVdPUJhc2VDbGFzcy51c2FnZU1ldHJpY01hcFtwcm9wcy5jb25zdHJ1Y3ROYW1lXSsxO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoJ2NvbnN0cnVjdCBuYW1lIGlzIG5vdCBwcmVzZW50IGluIHVzYWdlTWV0cmljTWFwICcpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB1c2FnZU1ldHJpY01hcFNlcmlhbGl6ZWQgPSBKU09OLnN0cmluZ2lmeShCYXNlQ2xhc3MudXNhZ2VNZXRyaWNNYXApLnJlcGxhY2UoL1t7fV0vZywgJycpLnJlcGxhY2UoL1wiL2csICcnKTtcblxuICAgICAgLy8gRGVzY3JpcHRpb24gZm9ybWF0IDoodXNhZ2UgaWQgOnVrc2ItMXR1cGJvYzQ1KSh2ZXJzaW9uOjAuMC4wKSAoY29uc3RydWN0cyA6Ojp7XFxcIkMxXFxcIjoxLFxcXCJDMlxcXCI6NSxcXFwiQzNcXFwiOjMsXFxcIkM0XFxcIjowLFxcXCJDNVxcXCI6MCxcXFwiQzZcXFwiOjAsXFxcIkM3XFxcIjowLFxcXCJDOFxcXCI6MH0pIFwiLFxuICAgICAgLy8gd2hlcmUgQzEsQzIsIGV0YyBhcmUgbWFwcGVkIHdpdGggY29uc3RydWN0LW5hbWUtZW51bSBhbmQgdGhlIHZhbHVlcyBzaG93cyB0aGUgbnVtYmVyIG9mIHRpbWUgc3RhY2sgY3JlYXRlZC9kZWxldGVkLlxuICAgICAgU3RhY2sub2Yoc2NvcGUpLnRlbXBsYXRlT3B0aW9ucy5kZXNjcmlwdGlvbiA9XG4gICAgICBgRGVzY3JpcHRpb246ICgke3RoaXMuY29uc3RydWN0VXNhZ2VNZXRyaWN9KSAodmVyc2lvbjoke3ZlcnNpb259KSAodGFnOiR7IHVzYWdlTWV0cmljTWFwU2VyaWFsaXplZH0pIGA7XG5cbiAgICB9O1xuICB9XG5cbiAgLy8gb2JzZXJ2YWJpbGl0eVxuICBwcm90ZWN0ZWQgYWRkT2JzZXJ2YWJpbGl0eVRvQ29uc3RydWN0KHByb3BzOiBCYXNlQ2xhc3NQcm9wcykge1xuICAgIGlmIChwcm9wcy5vYnNlcnZhYmlsaXR5ID09IGZhbHNlKSB7XG4gICAgICB0aGlzLmVuYWJsZXhyYXkgPSBmYWxzZTtcbiAgICAgIHRoaXMubGFtYmRhVHJhY2luZyA9IGxhbWJkYS5UcmFjaW5nLkRJU0FCTEVEO1xuICAgICAgdGhpcy5maWVsZExvZ0xldmVsPSBhcHBzeW5jLkZpZWxkTG9nTGV2ZWwuTk9ORTtcbiAgICAgIHRoaXMucmV0ZW50aW9uPSBsb2dzLlJldGVudGlvbkRheXMuVEVOX1lFQVJTO1xuICAgIH07XG4gIH1cbn1cbiJdfQ==